BEGIN
    INSERT INTO public.users (id, email, display_name, image_url)
    VALUES (
      NEW.id,
      NEW.raw_user_meta_data ->> 'email',
      NEW.raw_user_meta_data ->> 'user_name',
      NEW.raw_user_meta_data ->> 'avatar_url'
    );

    UPDATE auth.users
    SET raw_user_meta_data = raw_user_meta_data || '{"role": "user"}'::jsonb
    WHERE auth.users.id = NEW.id;

    RETURN NEW;
END;


create trigger create_user_on_signup after insert on auth.users for each row execute function create_user_on_signup();